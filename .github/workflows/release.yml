name: Release Linux Packages

on:
  push:
    tags:
      - 'v*' # Se ejecuta solo cuando subes un tag (ej: v1.0.0)

jobs:
  build:
    name: Build & Package for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      # PRIMERO: Descargar dependencias del proyecto
      - name: Descargar dependencias del proyecto
        run: |
          go mod download
          go mod verify

      - name: Instalar dependencias de compilación (Fyne)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev libwayland-dev libxkbcommon-dev rpm

      # Instalar la NUEVA herramienta Fyne CLI
      - name: Instalar herramienta CLI de Fyne (nueva versión)
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Obtener versión del Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # 1. BINARIO ESTÁNDAR (Standalone)
      - name: Compilar Binario Normal
        run: |
          go build -ldflags "-s -w" -o CloudMount-Wizard ./cmd/cloudmount
          tar -czvf cloudmount-linux-amd64.tar.gz CloudMount-Wizard

      # 2. Paquetes usando fyne package (DEB y RPM)
      - name: Crear paquetes DEB y RPM
        run: |
          cd ./cmd/cloudmount
          ~/go/bin/fyne package -os linux -name "cloudmount-wizard" -icon ../../icon.png
          # Mover los paquetes al directorio raíz
          mv *.deb ../../cloudmount-wizard_${{ steps.get_version.outputs.VERSION }}_amd64.deb || true
          mv *.rpm ../../cloudmount-wizard-${{ steps.get_version.outputs.VERSION }}.x86_64.rpm || true
          cd ../..

      # 3. AppImage usando herramientas externas (ya que fyne package no soporta AppImage directamente)
      - name: Crear AppImage usando appimagetool
        run: |
          # Descargar appimagetool
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Crear estructura AppDir
          mkdir -p CloudMount-Wizard.AppDir/usr/bin
          mkdir -p CloudMount-Wizard.AppDir/usr/share/applications
          mkdir -p CloudMount-Wizard.AppDir/usr/share/icons/hicolor/256x256/apps

          # Copiar el binario
          cp CloudMount-Wizard CloudMount-Wizard.AppDir/usr/bin/

          # Copiar el icono
          cp icon.png CloudMount-Wizard.AppDir/usr/share/icons/hicolor/256x256/apps/cloudmount-wizard.png
          cp icon.png CloudMount-Wizard.AppDir/cloudmount-wizard.png

          # Crear archivo .desktop
          cat > CloudMount-Wizard.AppDir/cloudmount-wizard.desktop << EOF
          [Desktop Entry]
          Name=CloudMount Wizard
          Exec=CloudMount-Wizard
          Icon=cloudmount-wizard
          Type=Application
          Categories=Utility;
          EOF

          cp CloudMount-Wizard.AppDir/cloudmount-wizard.desktop CloudMount-Wizard.AppDir/usr/share/applications/

          # Crear AppRun
          cat > CloudMount-Wizard.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/CloudMount-Wizard" "$@"
          EOF

          chmod +x CloudMount-Wizard.AppDir/AppRun

          # Crear AppImage
          ARCH=x86_64 ./appimagetool-x86_64.AppImage CloudMount-Wizard.AppDir CloudMount-Wizard.AppImage

      # SUBIR TODO A LA RELEASE DE GITHUB
      - name: Publicar Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            cloudmount-linux-amd64.tar.gz
            *.AppImage
            *.deb
            *.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
