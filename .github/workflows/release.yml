name: Release Linux Packages

on:
  push:
    tags:
      - 'v*' # Se ejecuta solo cuando subes un tag (ej: v1.0.0)

# IMPORTANTE: Dar permisos de escritura al workflow
permissions:
  contents: write

jobs:
  build:
    name: Build & Package for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      # PRIMERO: Descargar dependencias del proyecto
      - name: Descargar dependencias del proyecto
        run: |
          go mod download
          go mod verify

      - name: Instalar dependencias de compilación (Fyne)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev libwayland-dev libxkbcommon-dev rpm libfuse2 ruby ruby-dev
          sudo gem install fpm

      # Instalar la NUEVA herramienta Fyne CLI
      - name: Instalar herramienta CLI de Fyne (nueva versión)
        run: go install fyne.io/fyne/v2/cmd/fyne@latest

      - name: Obtener versión del Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # 1. BINARIO ESTÁNDAR (Standalone)
      - name: Compilar Binario Normal
        run: |
          go build -ldflags "-s -w" -o CloudMount-Wizard ./cmd/cloudmount
          tar -czvf cloudmount-linux-amd64.tar.gz CloudMount-Wizard

      # 2. AppImage usando herramientas externas
      - name: Crear AppImage
        run: |
          # Descargar appimagetool
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

          # Extraer appimagetool (no ejecutarlo como AppImage)
          ./appimagetool-x86_64.AppImage --appimage-extract

          # Crear estructura AppDir
          mkdir -p CloudMount-Wizard.AppDir/usr/bin
          mkdir -p CloudMount-Wizard.AppDir/usr/share/applications
          mkdir -p CloudMount-Wizard.AppDir/usr/share/icons/hicolor/256x256/apps

          # Copiar el binario
          cp CloudMount-Wizard CloudMount-Wizard.AppDir/usr/bin/

          # Copiar el icono
          cp icon.png CloudMount-Wizard.AppDir/usr/share/icons/hicolor/256x256/apps/cloudmount-wizard.png
          cp icon.png CloudMount-Wizard.AppDir/cloudmount-wizard.png

          # Crear archivo .desktop
          cat > CloudMount-Wizard.AppDir/cloudmount-wizard.desktop << EOF
          [Desktop Entry]
          Name=CloudMount Wizard
          Exec=CloudMount-Wizard
          Icon=cloudmount-wizard
          Type=Application
          Categories=Utility;
          EOF

          cp CloudMount-Wizard.AppDir/cloudmount-wizard.desktop CloudMount-Wizard.AppDir/usr/share/applications/

          # Crear AppRun
          cat > CloudMount-Wizard.AppDir/AppRun << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"
          exec "${HERE}/usr/bin/CloudMount-Wizard" "$@"
          EOF

          chmod +x CloudMount-Wizard.AppDir/AppRun

          # Crear AppImage usando el appimagetool extraído
          ARCH=x86_64 ./squashfs-root/AppRun CloudMount-Wizard.AppDir CloudMount-Wizard.AppImage

      # 3. Crear paquete DEB usando fpm
      - name: Crear paquete DEB
        run: |
          mkdir -p package-deb/usr/bin
          mkdir -p package-deb/usr/share/applications
          mkdir -p package-deb/usr/share/icons/hicolor/256x256/apps

          cp CloudMount-Wizard package-deb/usr/bin/cloudmount-wizard
          cp icon.png package-deb/usr/share/icons/hicolor/256x256/apps/cloudmount-wizard.png

          cat > package-deb/usr/share/applications/cloudmount-wizard.desktop << EOF
          [Desktop Entry]
          Name=CloudMount Wizard
          Exec=cloudmount-wizard
          Icon=cloudmount-wizard
          Type=Application
          Categories=Utility;
          EOF

          fpm -s dir -t deb -n cloudmount-wizard -v ${{ steps.get_version.outputs.VERSION }} \
            --description "CloudMount Wizard - Mount cloud storage as local drives" \
            --url "https://github.com/AnabasaSoft/CloudMount-Wizard" \
            --maintainer "AnabasaSoft" \
            --license "MIT" \
            -C package-deb \
            usr/bin usr/share

      # 4. Crear paquete RPM usando fpm
      - name: Crear paquete RPM
        run: |
          mkdir -p package-rpm/usr/bin
          mkdir -p package-rpm/usr/share/applications
          mkdir -p package-rpm/usr/share/icons/hicolor/256x256/apps

          cp CloudMount-Wizard package-rpm/usr/bin/cloudmount-wizard
          cp icon.png package-rpm/usr/share/icons/hicolor/256x256/apps/cloudmount-wizard.png

          cat > package-rpm/usr/share/applications/cloudmount-wizard.desktop << EOF
          [Desktop Entry]
          Name=CloudMount Wizard
          Exec=cloudmount-wizard
          Icon=cloudmount-wizard
          Type=Application
          Categories=Utility;
          EOF

          fpm -s dir -t rpm -n cloudmount-wizard -v ${{ steps.get_version.outputs.VERSION }} \
            --description "CloudMount Wizard - Mount cloud storage as local drives" \
            --url "https://github.com/AnabasaSoft/CloudMount-Wizard" \
            --maintainer "AnabasaSoft" \
            --license "MIT" \
            -C package-rpm \
            usr/bin usr/share

      # SUBIR ARCHIVOS A LA RELEASE DE GITHUB
      - name: Publicar Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            cloudmount-linux-amd64.tar.gz
            CloudMount-Wizard.AppImage
            *.deb
            *.rpm
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
