name: Release Linux Packages

on:
  push:
    tags:
      - 'v*' # Se ejecuta solo cuando subes un tag (ej: v1.0.0)

jobs:
  build:
    name: Build & Package for Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout código
        uses: actions/checkout@v4

      - name: Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      # PRIMERO: Descargar dependencias del proyecto
      - name: Descargar dependencias del proyecto
        run: |
          go mod download
          go mod verify

      - name: Instalar dependencias de compilación (Fyne)
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc libgl1-mesa-dev xorg-dev libwayland-dev libxkbcommon-dev rpm

      # Instalar la NUEVA herramienta Fyne CLI
      - name: Instalar herramienta CLI de Fyne (nueva versión)
        run: go install fyne.io/tools/cmd/fyne@latest

      - name: Obtener versión del Tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      # 1. BINARIO ESTÁNDAR (Standalone)
      - name: Compilar Binario Normal
        run: |
          go build -ldflags "-s -w" -o CloudMount-Wizard ./cmd/cloudmount
          tar -czvf cloudmount-linux-amd64.tar.gz CloudMount-Wizard

      # 2. APPIMAGE
      - name: Crear AppImage
        run: |
          ~/go/bin/fyne package -os linux -name "CloudMount-Wizard" -icon icon.png -appID com.anabasasoft.cloudmount -appVersion ${{ steps.get_version.outputs.VERSION }} -src ./cmd/cloudmount
          # La nueva versión crea el archivo con un nombre diferente, lo renombramos
          if [ -f "CloudMount-Wizard.AppImage" ]; then
            echo "AppImage creado correctamente"
          else
            echo "Buscando archivo AppImage..."
            find . -name "*.AppImage" -type f
            mv *.AppImage CloudMount-Wizard.AppImage 2>/dev/null || true
          fi

      # 3. PAQUETE .DEB (Debian/Ubuntu)
      - name: Crear .deb
        run: |
          ~/go/bin/fyne package -os linux -name "cloudmount-wizard" -icon icon.png -appID com.anabasasoft.cloudmount -appVersion ${{ steps.get_version.outputs.VERSION }} -src ./cmd/cloudmount
          # Renombrar si es necesario
          if [ ! -f "cloudmount-wizard.deb" ]; then
            find . -name "*.deb" -type f
            mv *.deb cloudmount-wizard_${{ steps.get_version.outputs.VERSION }}_amd64.deb 2>/dev/null || true
          fi

      # 4. PAQUETE .RPM (Fedora/RedHat)
      - name: Crear .rpm
        run: |
          ~/go/bin/fyne package -os linux -name "cloudmount-wizard" -icon icon.png -appID com.anabasasoft.cloudmount -appVersion ${{ steps.get_version.outputs.VERSION }} -src ./cmd/cloudmount
          # Renombrar si es necesario
          if [ ! -f "cloudmount-wizard.rpm" ]; then
            find . -name "*.rpm" -type f
            mv *.rpm cloudmount-wizard-${{ steps.get_version.outputs.VERSION }}.x86_64.rpm 2>/dev/null || true
          fi

      # SUBIR TODO A LA RELEASE DE GITHUB
      - name: Publicar Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            cloudmount-linux-amd64.tar.gz
            *.AppImage
            *.deb
            *.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
